# Authentication Microservice Description

**Authentication Microservice** - part of server overall application responsible for validating, generating and refreshing JWT access and refresh tokens

**Authentication Microservice** receives requests from Core Microservice via HTTP.

**Authentication Microservice** additionally process requests for OAuth 2.0 authentication flow.

## Technological Stack

### Main Technologies

- Express.js- Node.js framework. Documentation:
- **TS** - TypeScript, a high-level programming language that adds static typing with optional type annotations to JavaScript. Documentation: <https://www.typescriptlang.org/>

### Libraries

The list of packages is not **exhaustive**, but includes most of required packages:

- **`jsonwebtoken`**
- **`bcryptjs`**
- **`passport`**
- **`passport-jwt`**
- **`passport-google-oauth20`**, **`passport-facebook`**, **`passport-github2`**
- **`ioredis`**
- **`dotenv`**
- **`cors`**

## Authentication flows

All requests for authentication even using OAuth 2.0 go first through **Core Microservice**, then **Core Microservice** communicates with **Authentication Microservice**.

### Email and password authentication flows

[Sign Up (SEQUENCE)](../Charts/Sequences%20diagrams.md#sign-up-sequence)

[Sign In & Token Generation (SEQUENCE)](../Charts/Sequences%20diagrams.md#sign-in-and-token-generation-sequence)

[Successful Access Token Validation (SEQUENCE)](../Charts/Sequences%20diagrams.md#successful-access-token-validation-sequence)

[Token expired → Unsuccessful Access Token Validation → Successful Token Refresh (SEQUENCE)](../Charts/Sequences%20diagrams.md#token-expired--unsuccessful-access-token-validation--successful-token-refresh-sequence)

[Token expired → Unsuccessful Access Token Validation → Unsuccessful Token Refresh (SEQUENCE)](../Charts/Sequences%20diagrams.md#token-expired--unsuccessful-access-token-validation--unsuccessful-token-refresh-sequence)

[Logout (SEQUENCE)](../Charts/Sequences%20diagrams.md#logout-sequence)

### OAuth 2.0 authentication flows

[First-Time User Login via OAuth 2.0 (SEQUENCE)](../Charts/Sequences%20diagrams.md#first-time-user-login-via-oauth-20-sequence)

[Existing User Login via OAuth 2.0 (SEQUENCE)](../Charts/Sequences%20diagrams.md#existing-user-login-via-oauth-20-sequence)

> Flows for access token being expired and requiring *refresh*, *access token validation*, *logout flows* are the same **as for authentication with email and password** for **OAuth 2.0 based authentication.**

## Authentication API Descriptions

### Core Microservice (API Gateway)

This service is the public entry point for all client requests.

#### AuthenticationController

**Global Path:** `/auth`

| HTTP Method | Path                | Body / Query                          | Controller Method                     | Description                                                                 | Used In                                                                 |
|-------------|---------------------|---------------------------------------|---------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------|
| POST        | /login              | Body: { email, password }             | `login(credentials)`                  | Accepts email and password from the client for login.                       | Sign In & Token Generation (SEQUENCE)                                   |
| POST        | /refresh            | `refresh_token_id` (from cookies)     | `refresh(refresh_token_id)`           | Accepts a refresh_token_id to get a new pair of tokens.                     | Token expired → Refresh success/failure sequences                       |
| GET         | /login/[provider]   | Empty                                 | `handleOAuthLogin()`                  | Initiates the OAuth 2.0 login process.                                      | First-Time & Existing User Login via OAuth 2.0 (SEQUENCE)               |
| GET         | /[provider]/callback| Query parameter: `code`               | `handleOAuthCallback(authorization_code)` | Handles the callback from the OAuth 2.0 provider.                           | First-Time & Existing User Login via OAuth 2.0 (SEQUENCE)               |
| POST        | /logout             | `refresh_token_id` (from cookies)     | `logout(refresh_token_id)`            | Initiates the logout process.                                               | Logout (SEQUENCE)                                                       |
| POST        | /signup             | DTO from body                         | `signUp(signUpDto)`                   | Accepts new user data (email, password, username, etc.) for registration.   | Sign Up (SEQUENCE)                                                      |

#### AuthService (Core Microservice / API Gateway)

| Service Method                  | Description                                                                 | Used In                                                                 |
|---------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------|
| handleLogin(credentials)        | Forwards credentials to the Authentication Microservice.                    | Sign In & Token Generation (SEQUENCE)                                   |
| handleOAuthInit()               | Makes an HTTP request to the Authentication Microservice to get a redirect URL. | First-Time & Existing User Login via OAuth 2.0 (SEQUENCE)               |
| handleOAuthCallback(code)       | Forwards the authorization_code to the Authentication Microservice.          | First-Time & Existing User Login via OAuth 2.0 (SEQUENCE)               |
| handleRefresh(refresh_token_id) | Forwards tokens to the Authentication Microservice for renewal.              | Token expired → Refresh success/failure sequences                       |
| handleLogout(refresh_token_id)  | Forwards the refresh_token_id to the Authentication Microservice to terminate the session. | Logout (SEQUENCE)                                                       |
| validateToken(accessToken)      | Called by AccessGuard. Makes an HTTP request to the Authentication Microservice to validate a token. | Successful Access Token Validation (SEQUENCE)                           |
| handleSignUp(signUpDto)         | Forwards registration data to the Authentication Microservice.               | Sign Up (SEQUENCE)                                                      |

#### AccessGuard

| Method        | Description                                                                 |
|---------------|-----------------------------------------------------------------------------|
| canActivate(context) | A NestJS Guard method. It intercepts protected requests and uses the AuthService for validation. |

### Authentication Microservice

This is an internal service that contains all authentication logic.

#### AuthController (Authentication Microservice)

**Global Path:** `/internal/auth` (assumed to be accessible only by internal services)

| HTTP Method | Path                 | Controller Method              | Description                                                | Used In                                                                 |
|-------------|----------------------|--------------------------------|------------------------------------------------------------|-------------------------------------------------------------------------|
| POST        | /login               | `login(credentials)`           | Verifies email/password and generates tokens.              | Sign In & Token Generation (SEQUENCE)                                   |
| POST        | /validate            | `validate(access_token)`       | Validates an access_token.                                 | Successful Access Token Validation (SEQUENCE)                           |
| POST        | /refresh             | `refreshTokens(refresh_token_id)` | Renews a pair of tokens.                                   | Token expired → Refresh success/failure sequences                       |
| POST        | /logout              | `handleLogout(refresh_token_id)` | Terminates a session and blacklists the tokens.            | Logout (SEQUENCE)                                                       |
| GET         | /oauth/initiate      | `initiateOAuthFlow()`          | Generates and returns a redirect URL for an OAuth provider.| First-Time & Existing User Login via OAuth 2.0 (SEQUENCE)               |
| POST        | /oauth/exchange-code | `exchangeCodeForTokens(code)`  | Exchanges an authorization code for internal tokens.       | First-Time & Existing User Login via OAuth 2.0 (SEQUENCE)               |
| POST        | /register            | `register(signUpDto)`          | Creates a new user based on the provided data.             | Sign Up (SEQUENCE)                                                      |

#### AuthService (Authentication Microservice)

> JWT generation logic can be moved into separate reusable private method `generateNewTokens()`.

| Service Method                  | Description                                                                 | Used In                                                                 |
|---------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------|
| authenticateUser(credentials)   | Checks credentials, creates a new pair of access and refresh tokens, saves the session. | Sign In & Token Generation (SEQUENCE)                                   |
| processRefreshToken(old_refresh_token_id) | Validates the old refresh token in Redis and generates a new pair of tokens. | Token expired → Refresh success/failure sequences                       |
| validateToken(access_token)     | Checks signature, expiration, and blacklist status of an access token.      | Successful Access Token Validation (SEQUENCE)                           |
| exchangeCodeForTokens(code)      | Exchanges the OAuth code for a user profile, finds/creates the user, and calls `generateNewTokens()`. | First-Time & Existing User Login via OAuth 2.0 (SEQUENCE)               |
| registerUser(signUpDto)         | Checks data uniqueness, hashes password, creates user in PostgreSQL, and generates tokens. | Sign Up (SEQUENCE)                                                      |

#### RedisRepository (a.k.a. RedisAuthRepository)

| Method                        | Description                                                                 |
|-------------------------------|-----------------------------------------------------------------------------|
| isTokenBlacklisted(token)     | Checks if a token’s id is in the blacklist.                                 |
| blacklistToken(token, expiresIn) | Adds a token’s id to the blacklist with a specified TTL.                  |
| storeRefreshTokenId(userId, refresh_token_id) | Saves a refresh_token’s id for a specific user, creating a session. |
| findSessionByTokenId(tokenId) | Finds an active session by the refresh_token’s id.                          |
